<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>„Ç≠„É£„É©„Çø„Ç§„Éî„É≥„Ç∞</title>

  <style>
    :root {
      --bg-dark: #030508;
      --bg-gradient: radial-gradient(circle at 60% -20%, #1a233a 0%, #05060a 70%);

      --glass: rgba(20, 25, 40, 0.85);
      /* Slightly more opaque for better contrast */
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-highlight: rgba(255, 255, 255, 0.03);

      --text: #eef2ff;
      --muted: #94a3b8;

      --primary: #3b82f6;
      --cyan: #06b6d4;
      --green: #10b981;
      --pink: #f43f5e;
      --gold: #f59e0b;

      --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
      --glow: 0 0 15px rgba(59, 130, 246, 0.3);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      background: var(--bg-dark);
      background-image: var(--bg-gradient);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
      /* Reduced padding */
      overflow-x: hidden;
    }

    .wrap {
      width: 100%;
      max-width: 1400px;
      /* Much wider max-width to allow large image */
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      height: 95vh;
      /* Occupy full height */
    }

    /* === Header / Meta === */
    .top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 16px;
      flex-shrink: 0;
      /* Prevent header from shrinking */
    }

    h1 {
      font-size: 20px;
      font-weight: 800;
      margin: 0;
      background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: 0.05em;
    }

    .meta {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .badge {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      padding: 6px 12px;
      border-radius: 99px;
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .badge span {
      color: var(--text);
      font-feature-settings: "tnum";
      font-size: 14px;
    }

    /* === Main Grid === */
    .grid {
      display: grid;
      /* Image gets more space (1.2fr) vs UI (1fr) */
      grid-template-columns: 1.2fr 1fr;
      gap: 20px;
      align-items: stretch;
      flex: 1;
      /* Fill remaining height */
      min-height: 0;
      /* Important for grid within flex */
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr auto;
      }

      .wrap {
        height: auto;
        display: block;
      }

      body {
        height: auto;
        padding: 20px;
      }

      .imgbox {
        min-height: 300px;
      }
    }

    .panel {
      background: var(--glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 24px;
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    /* === Left Panel (Image) - Maximized === */
    .panel.left {
      padding: 0;
      /* Remove padding for maximum image size */
      background: rgba(0, 0, 0, 0.2);
    }

    .imgbox {
      flex: 1;
      width: 100%;
      height: 100%;
      min-height: 50vh;
      /* Ensure significant height */
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      border-radius: 20px;
      overflow: hidden;
    }

    img {
      width: 100%;
      height: 100%;
      max-height: 85vh;
      /* Allow image to be very tall */
      object-fit: contain;
      filter: drop-shadow(0 10px 40px rgba(0, 0, 0, 0.5));
      transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
      transform-origin: center bottom;
    }

    /* Subtle hover effect on image */
    .imgbox:hover img {
      transform: scale(1.02);
    }

    /* Skip button overlay on image */
    .controls.overlay-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 10;
    }

    /* === Right Panel (Game UI) === */
    .panel.right {
      justify-content: center;
      gap: 20px;
      padding: 32px;
      /* Breathing room for UI */
    }

    .hint {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
      background: rgba(15, 23, 42, 0.4);
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.03);
    }

    .hint b {
      color: var(--text);
    }

    .guideBox {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 30px;
      text-align: center;
      box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.2);
      width: 100%;
      margin-bottom: 8px;
    }

    .guideBox .hint {
      background: transparent;
      padding: 0;
      border: none;
      margin-bottom: 16px;
      font-size: 12px;
      opacity: 0.7;
    }

    .romajiLine {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 36px;
      /* Larger text */
      font-weight: 500;
      min-height: 52px;
      letter-spacing: 0.05em;
      word-break: break-all;
      display: inline-block;
    }

    .ch {
      transition: color 0.1s;
      position: relative;
    }

    .ch.done {
      color: var(--muted);
      opacity: 0.4;
    }

    .ch.now {
      color: var(--cyan);
      text-shadow: 0 0 20px rgba(6, 182, 212, 0.6);
      font-weight: 700;
      border-bottom: 3px solid var(--cyan);
    }

    .ch.todo {
      color: var(--text);
    }

    .flashWrong {
      animation: shake 0.3s cubic-bezier(.36, .07, .19, .97) both;
      color: var(--pink) !important;
    }

    @keyframes shake {

      10%,
      90% {
        transform: translate3d(-1px, 0, 0);
      }

      20%,
      80% {
        transform: translate3d(2px, 0, 0);
      }

      30%,
      50%,
      70% {
        transform: translate3d(-4px, 0, 0);
      }

      40%,
      60% {
        transform: translate3d(4px, 0, 0);
      }
    }

    .pop {
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes popIn {
      from {
        opacity: 0;
        transform: scale(0.8) translateY(10px);
      }

      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    input {
      width: 100%;
      font-size: 24px;
      /* Larger input text */
      padding: 18px;
      border-radius: 16px;
      border: 2px solid rgba(255, 255, 255, 0.08);
      background: rgba(15, 23, 42, 0.6);
      color: var(--text);
      text-align: center;
      transition: all 0.2s ease;
      outline: none;
      margin-bottom: 8px;
    }

    input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
      background: rgba(15, 23, 42, 0.8);
    }

    .result {
      height: 32px;
      font-size: 20px;
      font-weight: 700;
      text-align: center;
      margin-top: -10px;
      transition: all 0.2s;
    }

    .result.ok {
      color: var(--green);
      text-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
    }

    .result.ng {
      color: var(--pink);
      text-shadow: 0 0 15px rgba(244, 63, 94, 0.5);
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: auto;
    }

    .controls.center {
      justify-content: center;
      width: 100%;
    }

    button {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text);
      padding: 12px 24px;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    button:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
    }

    #skipBtn {
      font-size: 13px;
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.6);
      border-color: rgba(255, 255, 255, 0.2);
    }

    #skipBtn:hover {
      background: rgba(0, 0, 0, 0.8);
    }

    #btn30,
    #btn60 {
      background: rgba(59, 130, 246, 0.15);
      border-color: rgba(59, 130, 246, 0.3);
      color: #bfdbfe;
    }

    #btn30:hover,
    #btn60:hover {
      background: rgba(59, 130, 246, 0.25);
      border-color: rgba(59, 130, 246, 0.5);
    }

    #resetBtn {
      background: rgba(244, 63, 94, 0.1);
      border-color: rgba(244, 63, 94, 0.2);
      color: #fecdd3;
    }

    #resetBtn:hover {
      background: rgba(244, 63, 94, 0.2);
    }

    /* Modal */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 20px;
    }

    .modal {
      background: #111827;
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 32px;
      width: 100%;
      max-width: 480px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
      text-align: center;
      animation: popIn 0.3s ease-out;
    }

    .modal h2 {
      margin: 0 0 20px;
      font-size: 24px;
      background: linear-gradient(to right, #fff, #94a3b8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .modal .line {
      color: var(--muted);
      font-size: 14px;
      margin-top: 16px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .modal .big {
      font-size: 48px;
      font-weight: 800;
      color: var(--text);
      line-height: 1;
      margin: 4px 0 24px;
      text-shadow: 0 0 30px rgba(59, 130, 246, 0.2);
    }

    .modal b {
      color: var(--text);
    }

    .modal .btnrow {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 32px;
    }

    .modal button {
      padding: 12px 24px;
      font-size: 16px;
    }

    #again60 {
      background: var(--primary);
      border-color: transparent;
      color: white;
    }

    #again60:hover {
      background: #2563eb;
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <h1>„Ç≠„É£„É©„Çø„Ç§„Éî„É≥„Ç∞</h1>
      <div class="meta">
        <div class="badge">‚è± <span id="time">‚Äî</span></div>
        <div class="badge">üéØ <span id="score">0</span></div>
        <div class="badge">‚å® <span id="kpm">0</span></div>
        <div class="badge">‚ùå <span id="miss">0</span></div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT (Maximized Image) -->
      <div class="panel left">
        <div class="imgbox">
          <img id="charImg" alt="„Ç≠„É£„É©ÁîªÂÉè" />
        </div>
        <div class="controls overlay-btn">
          <button id="skipBtn" type="button">„Çπ„Ç≠„ÉÉ„Éó ‚ñ∂</button>
        </div>
      </div>

      <!-- RIGHT (UI) -->
      <div class="panel right">
        <div class="guideBox">
          <div class="hint">ÔºàGREEN=OK / BLUE=NEXT / WHITE=TODOÔºâ</div>
          <div id="romaji" class="romajiLine"></div>
        </div>

        <input id="input" placeholder="„Åì„Åì„Å´ÂÖ•Âäõ (‰æã: hatsunemiku)" autocomplete="off" autocapitalize="off"
          spellcheck="false" />
        <div id="result" class="result"></div>

        <div class="hint" style="text-align: center; margin-top: 14px;">
          <b>30s</b> / <b>60s</b> „Åß„Çπ„Çø„Éº„Éà<br />
          NO Enter required / <b>Backspace</b> ÂØæÂøú
        </div>

        <div class="controls center">
          <button id="btn30" type="button">30Áßí„Çπ„Çø</button>
          <button id="btn60" type="button">60Áßí„Çπ„Çø</button>
          <button id="resetBtn" type="button">„É™„Çª„ÉÉ„Éà</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Result Modal -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="modal">
      <h2>RESULT</h2>
      <div class="line">SCORE</div>
      <div class="big"><span id="rScore">0</span></div>

      <div
        style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; background: rgba(0,0,0,0.2); padding: 16px; border-radius: 12px; margin-top: 12px;">
        <div>
          <div class="line" style="margin:0; font-size: 11px;">KPM</div>
          <div style="font-size: 24px; font-weight: 700;"><span id="rKpm">0</span></div>
        </div>
        <div>
          <div class="line" style="margin:0; font-size: 11px;">MISS</div>
          <div style="font-size: 24px; font-weight: 700; color: var(--pink);"><span id="rMiss">0</span></div>
        </div>
      </div>

      <div class="btnrow">
        <button id="closeResult" type="button">Èñâ„Åò„Çã</button>
        <button id="again60" type="button">„ÇÇ„ÅÜ‰∏ÄÂõû (60Áßí)</button>
      </div>
    </div>
  </div>

  <script>
  // ===== „Ç≠„É£„É©„Éá„Éº„Çø =====
  const ITEMS = [
    { name:"ÂàùÈü≥„Éü„ÇØ", yomi:"„ÅØ„Å§„Å≠ „Åø„Åè" },
    { name:"Èè°Èü≥„É™„É≥", yomi:"„Åã„Åå„Åø„Å≠ „Çä„Çì" },
    { name:"Èè°Èü≥„É¨„É≥", yomi:"„Åã„Åå„Åø„Å≠ „Çå„Çì" },
    { name:"Â∑°Èü≥„É´„Ç´", yomi:"„ÇÅ„Åê„Çä„Å≠ „Çã„Åã" },
    { name:"MEIKO",   yomi:"„ÇÅ„ÅÑ„Åì" },
    { name:"KAITO",   yomi:"„Åã„ÅÑ„Å®" },
    { name:"Êòü‰πÉ‰∏ÄÊ≠å", yomi:"„Åª„Åó„ÅÆ „ÅÑ„Å°„Åã" },
    { name:"Â§©È¶¨Âí≤Â∏å", yomi:"„Å¶„Çì„Åæ „Åï„Åç" },
    { name:"ÊúõÊúàÁ©ÇÊ≥¢", yomi:"„ÇÇ„Å°„Å•„Åç „Åª„Å™„Åø" },
    { name:"Êó•ÈáéÊ£ÆÂøóÊ≠©", yomi:"„Å≤„ÅÆ„ÇÇ„Çä „Åó„Åª" },
    { name:"Ëä±Èáå„Åø„ÅÆ„Çä", yomi:"„ÅØ„Å™„Åï„Å® „Åø„ÅÆ„Çä" },
    { name:"Ê°êË∞∑ÈÅ•", yomi:"„Åç„Çä„Åü„Å´ „ÅØ„Çã„Åã" },
    { name:"Ê°É‰∫ïÊÑõËéâ", yomi:"„ÇÇ„ÇÇ„ÅÑ „ÅÇ„ÅÑ„Çä" },
    { name:"Êó•ÈáéÊ£ÆÈõ´", yomi:"„Å≤„ÅÆ„ÇÇ„Çä „Åó„Åö„Åè" },
    { name:"Â∞èË±ÜÊ≤¢„Åì„ÅØ„Å≠", yomi:"„ÅÇ„Åö„Åï„Çè „Åì„ÅØ„Å≠" },
    { name:"ÁôΩÁü≥Êùè", yomi:"„Åó„Çâ„ÅÑ„Åó „ÅÇ„Çì" },
    { name:"Êù±Èõ≤ÂΩ∞‰∫∫", yomi:"„Åó„ÅÆ„ÅÆ„ÇÅ „ÅÇ„Åç„Å®" },
    { name:"ÈùíÊü≥ÂÜ¨Âº•", yomi:"„ÅÇ„Åä„ÇÑ„Åé „Å®„ÅÜ„ÇÑ" },
    { name:"Â§©È¶¨Âè∏", yomi:"„Å¶„Çì„Åæ „Å§„Åã„Åï" },
    { name:"È≥≥„Åà„ÇÄ", yomi:"„Åä„Åä„Å®„Çä „Åà„ÇÄ" },
    { name:"ËçâËñôÂØß„ÄÖ", yomi:"„Åè„Åï„Å™„Åé „Å≠„Å≠" },
    { name:"Á•û‰ª£È°û", yomi:"„Åã„Åø„Åó„Çç „Çã„ÅÑ" },
    { name:"ÂÆµÂ¥éÂ•è", yomi:"„Çà„ÅÑ„Åñ„Åç „Åã„Å™„Åß" },
    { name:"ÊúùÊØîÂ•à„Åæ„Åµ„ÇÜ", yomi:"„ÅÇ„Åï„Å≤„Å™ „Åæ„Åµ„ÇÜ" },
    { name:"Êù±Èõ≤ÁµµÂêç", yomi:"„Åó„ÅÆ„ÅÆ„ÇÅ „Åà„Å™" },
    { name:"ÁßãÂ±±ÁëûÁ®Ä", yomi:"„ÅÇ„Åç„ÇÑ„Åæ „Åø„Åö„Åç" },
  ];

  // ===== ÁîªÂÉèÊé¢Á¥¢Ôºàfile:// + Êó•Êú¨Ë™û„Éï„Ç°„Ç§„É´Âêç„Åß„ÇÇÂº∑„ÅÑÔºâ =====
  const DIR_CANDIDATES = ["images", "./images"];
  const EXT_CANDIDATES = ["jpg","jpeg","png","webp","jpg_large","JPG","JPEG","PNG","WEBP","Jpg","Png","Webp"];

  function normalizeYomi(y){ return (y ?? "").replace(/\s+/g," ").trim(); }
  function yomiNoSpace(y){ return normalizeYomi(y).replace(/\s+/g,""); }
  function buildBaseCandidates(name, yomi){
    const y1 = normalizeYomi(yomi);
    const y2 = yomiNoSpace(yomi);
    return [
      `${name}(${y1})`,
      `${name} (${y1})`,
      `${name}(${y2})`,
      `${name} (${y2})`,
    ];
  }
  function setCharacterImage(name, yomi, imgEl){
    const bases = buildBaseCandidates(name, yomi);
    let d=0, b=0, e=0;
    const tryNext = () => {
      if (d >= DIR_CANDIDATES.length) return;
      if (b >= bases.length) { d++; b=0; e=0; tryNext(); return; }
      if (e >= EXT_CANDIDATES.length) { b++; e=0; tryNext(); return; }

      const dir = DIR_CANDIDATES[d];
      const base = bases[b];
      const ext = EXT_CANDIDATES[e++];

      const filename = `${base}.${ext}`;
      const url = encodeURI(`${dir}/${filename}`);

      imgEl.onerror = tryNext;
      imgEl.src = url;
    };
    tryNext();
  }

  // ===== ÂäπÊûúÈü≥ÔºàWebAudioÔºâ =====
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  const audioCtx = new AudioCtx();
  function beep({freq=880, duration=0.06, type="square", gain=0.05} = {}){
    const t0 = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, t0);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + duration);
    osc.connect(g).connect(audioCtx.destination);
    osc.start(t0);
    osc.stop(t0 + duration + 0.01);
  }
  const seOk = ()=>{
    beep({freq: 880, duration: 0.05, type:"square", gain:0.06});
    beep({freq: 1320, duration: 0.05, type:"square", gain:0.05});
  };
  const seMiss = ()=> beep({freq: 180, duration: 0.10, type:"sawtooth", gain:0.05});

  // ===== „Å≤„Çâ„Åå„Å™‚Üí„É≠„Éº„ÉûÂ≠óÔºàË§áÊï∞ÂÖ•ÂäõÂØæÂøúÔºâ =====
  const ROMA_MAP_2 = {
    "„Åç„ÇÉ":["kya"], "„Åç„ÇÖ":["kyu"], "„Åç„Çá":["kyo"],
    "„Åé„ÇÉ":["gya"], "„Åé„ÇÖ":["gyu"], "„Åé„Çá":["gyo"],
    "„Åó„ÇÉ":["sha","sya"], "„Åó„ÇÖ":["shu","syu"], "„Åó„Çá":["sho","syo"],
    "„Åò„ÇÉ":["ja","zya","jya"], "„Åò„ÇÖ":["ju","zyu","jyu"], "„Åò„Çá":["jo","zyo","jyo"],
    "„Å°„ÇÉ":["cha","tya"], "„Å°„ÇÖ":["chu","tyu"], "„Å°„Çá":["cho","tyo"],
    "„Å´„ÇÉ":["nya"], "„Å´„ÇÖ":["nyu"], "„Å´„Çá":["nyo"],
    "„Å≤„ÇÉ":["hya"], "„Å≤„ÇÖ":["hyu"], "„Å≤„Çá":["hyo"],
    "„Åø„ÇÉ":["mya"], "„Åø„ÇÖ":["myu"], "„Åø„Çá":["myo"],
    "„Çä„ÇÉ":["rya"], "„Çä„ÇÖ":["ryu"], "„Çä„Çá":["ryo"],
    "„Å≥„ÇÉ":["bya"], "„Å≥„ÇÖ":["byu"], "„Å≥„Çá":["byo"],
    "„Å¥„ÇÉ":["pya"], "„Å¥„ÇÖ":["pyu"], "„Å¥„Çá":["pyo"],
  };

  const ROMA_MAP_1 = {
    "„ÅÇ":["a"], "„ÅÑ":["i"], "„ÅÜ":["u"], "„Åà":["e"], "„Åä":["o"],
    "„Åã":["ka"], "„Åç":["ki"], "„Åè":["ku"], "„Åë":["ke"], "„Åì":["ko"],
    "„Åï":["sa"], "„Åó":["shi","si"], "„Åô":["su"], "„Åõ":["se"], "„Åù":["so"],
    "„Åü":["ta"], "„Å°":["chi","ti"], "„Å§":["tsu","tu"], "„Å¶":["te"], "„Å®":["to"],
    "„Å™":["na"], "„Å´":["ni"], "„Å¨":["nu"], "„Å≠":["ne"], "„ÅÆ":["no"],
    "„ÅØ":["ha"], "„Å≤":["hi"], "„Åµ":["fu","hu"], "„Å∏":["he"], "„Åª":["ho"],
    "„Åæ":["ma"], "„Åø":["mi"], "„ÇÄ":["mu"], "„ÇÅ":["me"], "„ÇÇ":["mo"],
    "„ÇÑ":["ya"], "„ÇÜ":["yu"], "„Çà":["yo"],
    "„Çâ":["ra"], "„Çä":["ri"], "„Çã":["ru"], "„Çå":["re"], "„Çç":["ro"],
    "„Çè":["wa"], "„Çí":["wo","o"],
    "„Åå":["ga"], "„Åé":["gi"], "„Åê":["gu"], "„Åí":["ge"], "„Åî":["go"],
    "„Åñ":["za"], "„Åò":["ji","zi"], "„Åö":["zu"], "„Åú":["ze"], "„Åû":["zo"],
    "„Å†":["da"], "„Å¢":["ji","di"], "„Å•":["zu","du"], "„Åß":["de"], "„Å©":["do"],
    "„Å∞":["ba"], "„Å≥":["bi"], "„Å∂":["bu"], "„Åπ":["be"], "„Åº":["bo"],
    "„Å±":["pa"], "„Å¥":["pi"], "„Å∑":["pu"], "„Å∫":["pe"], "„ÅΩ":["po"],

    "„ÅÅ":["a"], "„ÅÉ":["i"], "„ÅÖ":["u"], "„Åá":["e"], "„Åâ":["o"],
    "„ÇÉ":["ya"], "„ÇÖ":["yu"], "„Çá":["yo"],

    "„Çì":["n","nn"],
  };

  function tokenizeKana(yomi){
    const s = (yomi ?? "").replace(/\s+/g,"").trim();
    const tokens = [];
    for(let i=0; i<s.length; i++){
      const c = s[i];
      if(c === "„Å£"){ tokens.push("„Å£"); continue; }
      const two = s.slice(i, i+2);
      if(ROMA_MAP_2[two]){
        tokens.push(two);
        i++;
      }else{
        tokens.push(c);
      }
    }
    return tokens;
  }

  function applySokuonToOptions(nextOpts){
    // „Å£ + Ê¨°„ÅÆ„É≠„Éº„ÉûÂ≠ó„ÅÆÂÖàÈ†≠Â≠êÈü≥„ÇíÈáç„Å≠„ÇãÔºà‰æãÔºöchi -> cchi / shi -> sshiÔºâ
    return nextOpts.map(opt=>{
      const first = opt[0] ?? "";
      if(!first) return opt;
      // ÊØçÈü≥Âßã„Åæ„Çä„ÅØ„Åù„ÅÆ„Åæ„ÅæÔºà„Åª„ÅºÂá∫„Å™„ÅÑ„ÅåÂÆâÂÖ®Ôºâ
      if("aeiou".includes(first)) return opt;
      return first + opt;
    });
  }

  function buildRomajiVariants(yomi, limit=256){
    const tokens = tokenizeKana(yomi);
    let optionsPerToken = [];
    let pendingSokuon = false;

    for(const t of tokens){
      if(t === "„Å£"){ pendingSokuon = true; continue; }

      let opts = ROMA_MAP_2[t] || ROMA_MAP_1[t] || [t]; // Êú™ÂÆöÁæ©„ÅØ„Åù„ÅÆ„Åæ„Åæ
      if(pendingSokuon){
        opts = applySokuonToOptions(opts);
        pendingSokuon = false;
      }
      optionsPerToken.push(opts);
    }

    // canonicalÔºàË°®Á§∫Áî®Ôºâ„ÅØÂêÑ„Éà„Éº„ÇØ„É≥„ÅÆÂÖàÈ†≠ÂÄôË£ú„ÅßÂêàÊàê
    const canonical = optionsPerToken.map(o=>o[0]).join("").toLowerCase();

    // Â§âÊèõÂÄôË£úÔºàÁàÜÁô∫„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´‰∏äÈôê„Å§„Åç„ÅßÁîüÊàêÔºâ
    let variants = [""];
    for(const opts of optionsPerToken){
      const next = [];
      for(const base of variants){
        for(const opt of opts){
          if(next.length >= limit) break;
          next.push((base + opt).toLowerCase());
        }
        if(next.length >= limit) break;
      }
      variants = next;
      if(variants.length >= limit) break;
    }

    // ÈáçË§áÊéíÈô§
    variants = Array.from(new Set(variants));

    return { canonical, variants };
  }

  const esc = s => s.replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

  // ===== DOM =====
  const elImg = document.getElementById("charImg");
  const elRomaji = document.getElementById("romaji");
  const elInput = document.getElementById("input");
  const elResult = document.getElementById("result");
  const elScore = document.getElementById("score");
  const elMiss = document.getElementById("miss");
  const elTime = document.getElementById("time");
  const elKpm = document.getElementById("kpm");
  const overlay = document.getElementById("overlay");
  const rScore = document.getElementById("rScore");
  const rKpm = document.getElementById("rKpm");
  const rMiss = document.getElementById("rMiss");

  // ===== Áä∂ÊÖã =====
  let deck = [];
  let current = null;

  let canonical = "";
  let variants = [];
  let typed = ""; // ÂÖ•ÂäõÊ∏à„ÅøÔºàËá™ÂâçÁÆ°ÁêÜÔºâ
  let displayTarget = ""; // „Ç¨„Ç§„ÉâË°®Á§∫Áî®Ôºàtyped„Å´Âêà„ÅÜÂÄôË£ú„ÇíÈÅ∏„Å∂Ôºâ

  let score = 0;
  let miss = 0;

  let timer = null;
  let timeLeft = 60;
  let startTime = 0;
  let typedCount = 0;

  function pickDisplayTarget(){
    // typed „ÇíÂâçÊñπ‰∏ÄËá¥„Åô„ÇãÂÄôË£ú„ÇíÂÑ™ÂÖà„Åó„Å¶Ë°®Á§∫Ôºà„Å™„Åë„Çå„Å∞canonicalÔºâ
    const v = variants.find(s => s.startsWith(typed));
    return v || canonical || "";
  }

  function renderGuide(){
    displayTarget = pickDisplayTarget();
    const progress = typed.length;

    elRomaji.innerHTML = displayTarget.split("").map((ch,i)=>{
      const cls = "ch " + (i < progress ? "done" : i === progress ? "now" : "todo");
      return `<span class="${cls}" data-i="${i}">${esc(ch)}</span>`;
    }).join("") || '<span class="hint">Ôºà„Åì„Åì„Å´„É≠„Éº„ÉûÂ≠ó„ÅåÂá∫„Åæ„ÅôÔºâ</span>';
  }

  function flashWrong(){
    const span = elRomaji.querySelector(`span[data-i="${typed.length}"]`);
    if(!span) return;
    span.classList.remove("flashWrong");
    void span.offsetWidth;
    span.classList.add("flashWrong");
  }

  function popGuide(){
    elRomaji.classList.add("pop");
    setTimeout(()=>elRomaji.classList.remove("pop"), 220);
  }

  function nextQuestion(){
    if(deck.length === 0) deck = shuffle([...ITEMS]);
    current = deck.pop();

    // ÁîªÂÉè
    setCharacterImage(current.name, current.yomi, elImg);

    // „É≠„Éº„ÉûÂ≠óÂÄôË£ú
    const built = buildRomajiVariants(current.yomi, 256);
    canonical = built.canonical;
    variants = built.variants;

    typed = "";
    renderGuide();
    popGuide();

    elResult.textContent = "";
    elResult.className = "result";

    elInput.value = "";
    elInput.focus();
  }

  function updateKpm(){
    const minutes = (Date.now() - startTime) / 60000;
    const kpm = minutes > 0 ? Math.round(typedCount / minutes) : 0;
    elKpm.textContent = kpm;
    return kpm;
  }

  function startGame(sec){
    if (audioCtx.state === "suspended") audioCtx.resume();

    stopGame();
    closeResult();

    score = 0; miss = 0; typedCount = 0;
    elScore.textContent = score;
    elMiss.textContent = miss;
    elKpm.textContent = "0";
    elResult.textContent = "";
    elResult.className = "result";

    timeLeft = sec;
    elTime.textContent = `${timeLeft}s`;

    startTime = Date.now();
    deck = shuffle([...ITEMS]);
    nextQuestion();

    timer = setInterval(()=>{
      timeLeft--;
      elTime.textContent = `${timeLeft}s`;
      updateKpm();
      if(timeLeft <= 0) endGame();
    }, 1000);
  }

  function stopGame(){
    if(timer){ clearInterval(timer); timer = null; }
  }

  function endGame(){
    stopGame();
    const kpm = updateKpm();
    rScore.textContent = score;
    rKpm.textContent = kpm;
    rMiss.textContent = miss;
    overlay.style.display = "flex";
    overlay.setAttribute("aria-hidden","false");
  }

  function closeResult(){
    overlay.style.display = "none";
    overlay.setAttribute("aria-hidden","true");
  }

  function resetGame(){
    stopGame();
    closeResult();

    score = 0; miss = 0; typedCount = 0;
    elScore.textContent = "0";
    elMiss.textContent = "0";
    elKpm.textContent = "0";
    elTime.textContent = "‚Äî";
    elResult.textContent = "";
    elResult.className = "result";

    deck = shuffle([...ITEMS]);
    nextQuestion();
  }

  // ===== ÂÖ•ÂäõÂà§ÂÆöÔºàË§áÊï∞ÂÄôË£úÔºâ =====
  elInput.addEventListener("keydown", (e)=>{
    if(!timer) return;

    const key = e.key;

    if(key === "Escape"){
      e.preventDefault();
      nextQuestion();
      return;
    }

    if(key === "Backspace"){
      e.preventDefault();
      if(typed.length > 0){
        typed = typed.slice(0, -1);
        renderGuide();
        elResult.textContent = "";
        elResult.className = "result";
      }
      // ÁîªÈù¢„ÅÆinputÊ¨Ñ„ÅØË¶ã„ÅüÁõÆ„Å†„ÅëÔºàËá™Ââç„ÅßtypedÁÆ°ÁêÜÔºâ
      elInput.value = typed;
      return;
    }

    if(key === "Enter"){
      e.preventDefault();
      return;
    }

    if(key.length !== 1) return;

    e.preventDefault();
    typedCount++;

    const ch = key.toLowerCase();
    const nextTyped = typed + ch;

    // „Å©„Çå„Åã„ÅÆÂÄôË£ú„Åå nextTyped „ÇíÂâçÊñπ‰∏ÄËá¥„Åó„Å¶„ÅÑ„Çå„Å∞OK
    const okPrefix = variants.some(v => v.startsWith(nextTyped));

    if(okPrefix){
      typed = nextTyped;
      elInput.value = typed;
      renderGuide();
      seOk();

      // „Å©„Çå„Åã„ÅÆÂÄôË£ú„Å®ÂÆåÂÖ®‰∏ÄËá¥„Åó„Åü„ÇâÊ≠£Ëß£
      const okFull = variants.some(v => v === typed);
      if(okFull){
        score++;
        elScore.textContent = score;

        elResult.textContent = "‚úÖ OK!";
        elResult.className = "result ok";

        setTimeout(()=>{
          elResult.textContent = "";
          elResult.className = "result";
          nextQuestion();
        }, 220);
      }
    }else{
      miss++;
      elMiss.textContent = miss;
      elResult.textContent = "‚ùå";
      elResult.className = "result ng";
      flashWrong();
      seMiss();
      // inputÊ¨Ñ„Å´„ÅØÂèçÊò†„Åó„Å™„ÅÑÔºàtyped„ÅØÂ¢ó„ÇÑ„Åï„Å™„ÅÑÔºâ
      elInput.value = typed;
    }
  });

  // ===== „Éú„Çø„É≥ =====
  document.getElementById("btn30").addEventListener("click", ()=>startGame(30));
  document.getElementById("btn60").addEventListener("click", ()=>startGame(60));
  document.getElementById("resetBtn").addEventListener("click", resetGame);
  document.getElementById("skipBtn").addEventListener("click", ()=>nextQuestion());

  document.getElementById("closeResult").addEventListener("click", closeResult);
  document.getElementById("again60").addEventListener("click", ()=>startGame(60));

  // Ëµ∑ÂãïÊôÇÔºöÁîªÂÉè„Å®„Ç¨„Ç§„Éâ„Å†„ÅëË°®Á§∫ÔºàÈñãÂßã„ÅØ„Éú„Çø„É≥Ôºâ
  resetGame();
  </script>
</body>

</html>